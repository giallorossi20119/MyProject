/****************************************************************************
 Copyright (c) 2010 cocos2d-x.org

 http://www.cocos2d-x.org

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/

#import "AppController.h"
#import "CCEAGLView.h"
#import "cocos2d.h"
#import "AppDelegate.h"
#import "RootViewController.h"
#import "SFSConnection.h"
#import "LoginHandler.h"
#import "ASIFormDataRequest.h"
#import "ASIHTTPRequest.h"
//#import <GoogleOpenSource/GoogleOpenSource.h>
//#import <GooglePlus/GooglePlus.h>
@implementation AppController

#pragma mark -
#pragma mark Application lifecycle
@class GTMOAuth2Authentication;
// cocos2d application instance
static AppDelegate s_sharedApplication;
static AppController* me;
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    // Override point for customization after application launch.

    // Add the view controller's view to the window and display.
    window = [[UIWindow alloc] initWithFrame: [[UIScreen mainScreen] bounds]];

    // Init the CCEAGLView
    CCEAGLView *eaglView = [CCEAGLView viewWithFrame: [window bounds]
                                         pixelFormat: kEAGLColorFormatRGBA8
                                         depthFormat: GL_DEPTH24_STENCIL8_OES
                                  preserveBackbuffer: NO
                                          sharegroup: nil
                                       multiSampling: NO
                                     numberOfSamples: 0];

    // Use RootViewController manage CCEAGLView
    _viewController = [[RootViewController alloc] initWithNibName:nil bundle:nil];
    //_viewController.wantsFullScreenLayout = YES;
    _viewController.view = eaglView;

    // Set RootViewController to window
    if ( [[UIDevice currentDevice].systemVersion floatValue] < 6.0)
    {
        // warning: addSubView doesn't work on iOS6
        [window addSubview: _viewController.view];
    }
    else
    {
        // use this method on ios6
        [window setRootViewController:_viewController];
    }

    [window makeKeyAndVisible];

    [[UIApplication sharedApplication] setStatusBarHidden:true];
    me = self;

    GPPSignIn *signIn = [GPPSignIn sharedInstance];
    //Google plus login
    signIn.shouldFetchGooglePlusUser = YES;
    signIn.shouldFetchGoogleUserEmail = YES;  // Uncomment to get the user's email
    // You previously set kClientId in the "Initialize the Google+ client" step
    signIn.clientID = @"496374930911-be2kehkr1qbi3mf19b9usmqth17pieg7.apps.googleusercontent.com";

    // Your server's OAuth 2.0 client ID
    //ssignIn.homeServerClientID = @"urn:ietf:wg:oauth:2.0:oob";
    // Uncomment one of these two statements for the scope you chose in the previous step
    //signIn.scopes = @[ @"https://www.googleapis.com/auth/plus.login." ];
    //signIn.scopes = @[ @"profile" ];            // "profile" scope
    signIn.scopes = @[ @"email"];

    signIn.scopes = [NSArray arrayWithObjects:
                     @"https://www.googleapis.com/auth/games",
                     @"https://www.googleapis.com/auth/appstate",
                     @"https://www.googleapis.com/auth/userinfo.email",
                     @"https://www.googleapis.com/auth/userinfo.profile",
                     @"https://www.googleapis.com/auth/plus.login",
                     @"https://www.googleapis.com/auth/plus.moments.write",
                     @"https://www.googleapis.com/auth/plus.me",
                     @"https://www.googleapis.com/auth/plus.profile.agerange.read",
                     @"https://www.googleapis.com/auth/plus.profile.language.read",
                     @"https://www.googleapis.com/auth/plus.circles.members.read",
                     @"openid",
                     nil];

    // Optional: declare signIn.actions, see "app activities"
    signIn.delegate = self;

    // IMPORTANT: Setting the GLView should be done after creating the RootViewController
    cocos2d::GLView *glview = cocos2d::GLView::createWithEAGLView(eaglView);
    cocos2d::Director::getInstance()->setOpenGLView(glview);
    cocos2d::Director::getInstance()->setDisplayStats(false);
    cocos2d::Application::getInstance()->run();
    return YES;
}

- (BOOL)application:(UIApplication *)application
            openURL:(NSURL *)url
  sourceApplication:(NSString *)sourceApplication
         annotation:(id)annotation {

    // Call FBAppCall's handleOpenURL:sourceApplication to handle Facebook app responses
    BOOL wasHandledFB = [FBAppCall handleOpenURL:url sourceApplication:sourceApplication];

    // You can add your app-specific url handling code here if needed
    BOOL wasHandledGP = [GPPURLHandler handleURL:url sourceApplication:sourceApplication annotation:annotation];
    return true;
}

//request response
- (void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response {
    // A response has been received, this is where we initialize the instance var you created
    // so that we can append data to it in the didReceiveData method
    // Furthermore, this method is called each time there is a redirect so reinitializing it
    // also serves to clear it
    //_responseData = [[NSMutableData alloc] init];

    NSHTTPCookie *cookie;
    NSString* sessionID;
    NSHTTPCookieStorage *cookieJar = [NSHTTPCookieStorage sharedHTTPCookieStorage];
    for (cookie in [cookieJar cookies])
    {
        NSLog(@"Login session id1 %@", cookie.name);
        if ([cookie.name isEqualToString:@"SESSa32639e00374d719e31425e62cf17ed3"])
        {
            sessionID = [NSString stringWithFormat:@"%@",[cookie value]];
        }
    }
    NSLog(@"Login session id2 %@", sessionID);
    GlobalVariable::m_sSID  = std::string([sessionID UTF8String]);
    ZoneData* zoneData = GlobalVariable::m_vGameServerData->at(GlobalVariable::m_iCurrentGame)->m_vZoneArray->at(GlobalVariable::m_iCurrentZone);
    SFSConnection::getInstance()->connectToServer(zoneData->m_sHostIp.c_str(), zoneData->m_iPort);
}

//login facebook
void loginByFacebook()
{
    NSLog(@"loginByFacebook");
    if (FBSession.activeSession.isOpen)
    {
        [me sendFacebookLogin];
    }
    else
    {

        [FBSession openActiveSessionWithReadPermissions:@[@"public_profile", @"user_friends", @"email"]
                                           allowLoginUI:YES
                                      completionHandler:
         ^(FBSession *session, FBSessionState state, NSError *error)
         {
             __block NSString *alertText;
             __block NSString *alertTitle;
             if (!error)
             {
                 // If the session was opened successfully
                 if (state == FBSessionStateOpen)
                 {
                     // Your code here
                     [me sendFacebookLogin];

                 }
                 else
                 {
                     // There was an error, handle it
                     if ([FBErrorUtility shouldNotifyUserForError:error] == YES)
                     {
                         // Error requires people using an app to make an action outside of the app to recover
                         // The SDK will provide an error message that we have to show the user
                         alertTitle = @"Something went wrong1";
                         alertText = [FBErrorUtility userMessageForError:error];
                         [[[UIAlertView alloc] initWithTitle:alertTitle
                                                     message:alertText
                                                    delegate:me
                                           cancelButtonTitle:@"OK!"
                                           otherButtonTitles:nil] show];

                     }
                     else
                     {
                         // If the user cancelled login
                         if ([FBErrorUtility errorCategoryForError:error] == FBErrorCategoryUserCancelled)
                         {
                             alertTitle = @"Login cancelled";
                             alertText = @"Your birthday will not be entered in our calendar because you didn't grant the permission.";
                             [[[UIAlertView alloc] initWithTitle:alertTitle
                                                         message:alertText
                                                        delegate:me
                                               cancelButtonTitle:@"OK!"
                                               otherButtonTitles:nil] show];

                         }
                         else
                         {
                             /*
                              // For simplicity, in this sample, for all other errors we show a generic message
                              // You can read more about how to handle other errors in our Handling errors guide
                              // https://developers.facebook.com/docs/ios/errors/
                              NSDictionary *errorInformation = [[[error.userInfo objectForKey:@"com.facebook.sdk:ParsedJSONResponseKey"]
                              objectForKey:@"body"]
                              objectForKey:@"error"];
                              alertTitle = @"Something went wrong2";
                              alertText = [NSString stringWithFormat:@"Please retry. \n If the problem persists contact us and mention this error code: %@",
                              [errorInformation objectForKey:@"message"]];
                              [[[UIAlertView alloc] initWithTitle:alertTitle
                              message:alertText
                              delegate:me
                              cancelButtonTitle:@"OK!"
                              otherButtonTitles:nil] show];
                              */
                         }
                     }
                 }
             }
             else
             {
                 NSLog(@"login facebook error");
                 // There was an error, handle it
                 if ([FBErrorUtility shouldNotifyUserForError:error] == YES)
                 {
                     // Error requires people using an app to make an action outside of the app to recover
                     // The SDK will provide an error message that we have to show the user
                     alertTitle = @"Something went wrong3";
                     alertText = [FBErrorUtility userMessageForError:error];
                     [[[UIAlertView alloc] initWithTitle:alertTitle
                                                 message:alertText
                                                delegate:me
                                       cancelButtonTitle:@"OK!"
                                       otherButtonTitles:nil] show];

                 }
                 else
                 {
                     // If the user cancelled login
                     if ([FBErrorUtility errorCategoryForError:error] == FBErrorCategoryUserCancelled)
                     {
                         alertTitle = @"Login cancelled";
                         alertText = @"Your birthday will not be entered in our calendar because you didn't grant the permission.";
                         [[[UIAlertView alloc] initWithTitle:alertTitle
                                                     message:alertText
                                                    delegate:me
                                           cancelButtonTitle:@"OK!"
                                           otherButtonTitles:nil] show];

                     }
                     else
                     {
                         // For simplicity, in this sample, for all other errors we show a generic message
                         // You can read more about how to handle other errors in our Handling errors guide
                         // https://developers.facebook.com/docs/ios/errors/
                         NSDictionary *errorInformation = [[[error.userInfo objectForKey:@"com.facebook.sdk:ParsedJSONResponseKey"]
                                                            objectForKey:@"body"]
                                                           objectForKey:@"error"];
                         alertTitle = @"Something went wrong4";
                         alertText = [NSString stringWithFormat:@"Please retry. \n If the problem persists contact us and mention this error code: %@",
                                      [errorInformation objectForKey:@"message"]];
                         [[[UIAlertView alloc] initWithTitle:alertTitle
                                                     message:alertText
                                                    delegate:me
                                           cancelButtonTitle:@"OK!"
                                           otherButtonTitles:nil] show];
                     }
                 }
             }
         }];
    }
}

-(void)sendFacebookLogin
{
    if (FBSession.activeSession.isOpen)
    {
        NSString *fbAccessToken = [[[FBSession activeSession] accessTokenData] accessToken];
        NSLog(@"fbAccessToken: %@", fbAccessToken);
        [[FBRequest requestForMe] startWithCompletionHandler:^(FBRequestConnection *connection, NSDictionary<FBGraphUser> *user, NSError *error)
         {
             if (!error)
             {
                 //LoginHandler* loginHandler = new LoginHandler();
                 //loginHandler->loginByFacebook(std::string([fbAccessToken UTF8String]));
                 //return;
                 ASIFormDataRequest* request1 = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:@"http://ids.gameloe.com/users/logout"]];
                 [request1 setCompletionBlock:^{
                     ASIFormDataRequest* request = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:@"http://ids.gameloe.com/facebook/login?m=1"]];
                     [request setPostValue:fbAccessToken forKey:@"access_token"];
                     [request setCompletionBlock:^{
                         NSData* data = [request responseData];
                         NSString *returnString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
                         NSLog(@"login: %@", returnString);
                         NSDictionary *jsonDataDict = [NSJSONSerialization JSONObjectWithData:data options: NSJSONReadingMutableContainers error: nil];
                         NSString  *sessionID;
                         int status = [[jsonDataDict objectForKey:@"status"] integerValue];
                         if (status == 1)
                         {
                             //status = 1, dang nhap thanh cong
                             //NSInteger UID = [[jsonDataDict objectForKey:@"err"] integerValue];
                             sessionID = [jsonDataDict objectForKey:@"sid"];
                         }
                         if (status == 0) {
                             //status = 0, dang nhap that bai
                         }

                         GlobalVariable::m_sSID  = std::string([sessionID UTF8String]);
                         ZoneData* zoneData = GlobalVariable::m_vGameServerData->at(GlobalVariable::m_iCurrentGame)->m_vZoneArray->at(GlobalVariable::m_iCurrentZone);
                         SFSConnection::getInstance()->connectToServer(zoneData->m_sHostIp.c_str(), zoneData->m_iPort);
                     }];
                     [request setFailedBlock:^{

                     }];
                     dispatch_async(dispatch_get_main_queue(), ^{
                         [request startAsynchronous];
                     });
                 }];
                 [request1 setFailedBlock:^{

                 }];
                 dispatch_async(dispatch_get_main_queue(), ^{
                     [request1 startAsynchronous];
                 });
             }
         }];

    }
}

void logoutByFacebook()
{
    if (FBSession.activeSession.isOpen)
    {
        [[FBSession activeSession] closeAndClearTokenInformation];
    }
}

void loginByGooglePlus()
{
    [[GPPSignIn sharedInstance] authenticate];
}


-(void)sendGooglePlusLogin
{
    NSString* code = [GPPSignIn sharedInstance].authentication.code;
    //NSLog(@"Google Access Token: %@", ggAccessToken);
    ASIFormDataRequest* request1 = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:@"http://ids.gameloe.com/users/logout"]];
    [request1 setCompletionBlock:^{

        ASIFormDataRequest* request = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:@"http://ids.gameloe.com/google/login?m=1"]];
        [request setPostValue:code forKey:@"code"];
        [request setCompletionBlock:^{
            NSData* data = [request responseData];
            NSString *returnString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
            //NSLog(@"login: %@", returnString);
            NSDictionary *jsonDataDict = [NSJSONSerialization JSONObjectWithData:data options: NSJSONReadingMutableContainers error: nil];
            NSString  *sessionID;
            int status = [[jsonDataDict objectForKey:@"status"] integerValue];
            if (status == 1)
            {
                //status = 1, dang nhap thanh cong
                //NSInteger UID = [[jsonDataDict objectForKey:@"err"] integerValue];
                sessionID = [jsonDataDict objectForKey:@"sid"];
            }
            if (status == 0) {
                //status = 0, dang nhap that bai
            }

            GlobalVariable::m_sSID  = std::string([sessionID UTF8String]);
            ZoneData* zoneData = GlobalVariable::m_vGameServerData->at(GlobalVariable::m_iCurrentGame)->m_vZoneArray->at(GlobalVariable::m_iCurrentZone);
            SFSConnection::getInstance()->connectToServer(zoneData->m_sHostIp.c_str(), zoneData->m_iPort);
        }];
        [request setFailedBlock:^{

        }];
        dispatch_async(dispatch_get_main_queue(), ^{
            [request startAsynchronous];
        });
    }];
    [request1 setFailedBlock:^{

    }];
    dispatch_async(dispatch_get_main_queue(), ^{
        [request1 startAsynchronous];
    });
}

- (void) finishedWithAuth:(GTMOAuth2Authentication *)auth error:(NSError *)error
{
    NSLog(@"finishedWithAuth error %@", error);
    NSLog(@"finishedWithAuth auth %@", auth);//[GPPSignIn sharedInstance].authentication.code);
    [self sendGooglePlusLogin];
}

- (void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data {
    // Append the new data to the instance variable you declared
    //NSMutableData* _responseData = [[NSMutableData alloc] init];
    //[_responseData appendData:data];
    //NSString *strData = [[NSString alloc]initWithData:data encoding:NSUTF8StringEncoding];
    // Print out new string
    //NSLog(@"%@",strData);


}
- (void)applicationWillResignActive:(UIApplication *)application {
    /*
     Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.
     Use this method to pause ongoing tasks, disable timers, and throttle down OpenGL ES frame rates. Games should use this method to pause the game.
     */
    //We don't need to call this method any more. It will interupt user defined game pause&resume logic
    /* cocos2d::Director::getInstance()->pause(); */
}

- (void)applicationDidBecomeActive:(UIApplication *)application {
    /*
     Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.
     */
    //We don't need to call this method any more. It will interupt user defined game pause&resume logic
    /* cocos2d::Director::getInstance()->resume(); */
}

- (void)applicationDidEnterBackground:(UIApplication *)application {
    /*
     Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later.
     If your application supports background execution, called instead of applicationWillTerminate: when the user quits.
     */
    cocos2d::Application::getInstance()->applicationDidEnterBackground();
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
    /*
     Called as part of  transition from the background to the inactive state: here you can undo many of the changes made on entering the background.
     */
    cocos2d::Application::getInstance()->applicationWillEnterForeground();
}

- (void)applicationWillTerminate:(UIApplication *)application {
    /*
     Called when the application is about to terminate.
     See also applicationDidEnterBackground:.
     */
}


#pragma mark -
#pragma mark Memory management

- (void)applicationDidReceiveMemoryWarning:(UIApplication *)application {
    /*
     Free up as much memory as possible by purging cached data objects that can be recreated (or reloaded from disk) later.
     */
}


- (void)dealloc {
    [window release];
    [super dealloc];
}


@end
